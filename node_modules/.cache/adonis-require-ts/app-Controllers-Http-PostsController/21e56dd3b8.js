"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const Post_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Post"));
const StorePostValidator_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Validators/Posts/StorePostValidator"));
const UpdatePostValidator_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Validators/Posts/UpdatePostValidator"));
const Application_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Core/Application"));
class PostsController {
    async index({ response }) {
        const posts = await Post_1.default
            .query()
            .preload('user')
            .orderBy('created_at', 'desc');
        return response.ok(posts);
    }
    async likes({ request, response }) {
        const payload = request.body();
        const post = await Post_1.default.findOrFail(payload.post_id);
        const liked_by = post.$attributes.liked_by;
        let unpackArr = JSON.parse(liked_by);
        unpackArr == null ?? [];
        if (unpackArr != null && unpackArr.includes(parseInt(payload.user_id))) {
            let index = unpackArr.indexOf(parseInt(payload.user_id));
            unpackArr.splice(index);
        }
        else {
            unpackArr.push(parseInt(payload.user_id));
        }
        let mergeable = {};
        let json = JSON.stringify(unpackArr);
        Object.assign(mergeable, { liked_by: json });
        post.merge(mergeable).save();
        return response.ok(post);
    }
    async store({ request, response }) {
        let url = "";
        const file = request.file('file', {
            size: '2mb',
            extnames: ['jpg', 'jpeg', 'png'],
        });
        if (file != null && !file.isValid) {
            return response.send({ message: "Le fichier n'est pas au bon format" });
        }
        else {
            if (file != null && file.isValid) {
                await file.move(Application_1.default.tmpPath('uploads'));
                console.log(file);
                url = `http://localhost:3333/uploads/${file.fileName}`;
                console.log('if');
            }
            else {
                console.log('else');
            }
        }
        const payload = await request.validate(StorePostValidator_1.default);
        console.log(url);
        payload.img_url = url;
        const post = await Post_1.default.create(payload);
        return response.created(post);
    }
    async show({ response, params }) {
        const post = await Post_1.default.findOrFail(params);
        return response.ok(post);
    }
    async update({ request, response, params }) {
        const post = await Post_1.default.findOrFail(params.id);
        const payload = await request.validate(UpdatePostValidator_1.default);
        let url = "";
        const file = request.file('file', {
            size: '2mb',
            extnames: ['jpg', 'jpeg', 'png'],
        });
        if (file != null && !file.isValid) {
            return response.send({ message: "Le fichier n'est pas au bon format" });
        }
        else {
            if (file != null && file.isValid) {
                await file.move(Application_1.default.tmpPath('uploads'));
                url = `http://localhost:3333/uploads/${file.fileName}`;
                payload.img_url = url;
            }
        }
        post.merge(payload).save();
        return response.ok(post);
    }
    async destroy({ response, params }) {
        const post = await Post_1.default.findOrFail(params.id);
        post.delete();
        return response.ok(post);
    }
}
exports.default = PostsController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUG9zdHNDb250cm9sbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiUG9zdHNDb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQ0EsaUZBQWtDO0FBQ2xDLHVIQUF3RTtBQUN4RSx5SEFBMEU7QUFDMUUsZ0dBQXNEO0FBRXRELE1BQXFCLGVBQWU7SUFDM0IsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFLFFBQVEsRUFBdUI7UUFFbEQsTUFBTSxLQUFLLEdBQUcsTUFBTSxjQUFJO2FBQ3JCLEtBQUssRUFBRTthQUNQLE9BQU8sQ0FBQyxNQUFNLENBQUM7YUFDZixPQUFPLENBQUMsWUFBWSxFQUFFLE1BQU0sQ0FBQyxDQUFBO1FBRWhDLE9BQU8sUUFBUSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUMzQixDQUFDO0lBQ00sS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQXVCO1FBQzNELE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQTtRQUM5QixNQUFNLElBQUksR0FBRyxNQUFNLGNBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQ25ELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFBO1FBQzFDLElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUE7UUFFcEMsU0FBUyxJQUFJLElBQUksSUFBSSxFQUFFLENBQUE7UUFHdkIsSUFBSSxTQUFTLElBQUksSUFBSSxJQUFJLFNBQVMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFO1lBQ3RFLElBQUksS0FBSyxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFBO1lBQ3hELFNBQVMsQ0FBQyxNQUFN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QUFNLEVBQUUsS0FBSyxDQUFDO1NBQ2pDLENBQUMsQ0FBQTtRQUNGLElBQUksSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDakMsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLG9DQUFvQyxFQUFFLENBQUMsQ0FBQTtTQUN4RTthQUFNO1lBQ0wsSUFBSSxJQUFJLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUU7Z0JBQ2hDLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxxQkFBVyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFBO2dCQUMvQyxHQUFHLEdBQUcsaUNBQWlDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQTtnQkFDdEQsT0FBTyxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUE7YUFDdEI7U0FDRjtRQUNELElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUE7UUFDMUIsT0FBTyxRQUFRLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQzFCLENBQUM7SUFFTSxLQUFLLENBQUMsT0FBTyxDQUFDLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBdUI7UUFFNUQsTUFBTSxJQUFJLEdBQUcsTUFBTSxjQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUM3QyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUE7UUFDYixPQUFPLFFBQVEsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDMUIsQ0FBQztDQUNGO0FBNUZELGtDQTRGQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgSHR0cENvbnRleHRDb250cmFjdCB9IGZyb20gJ0Bpb2M6QWRvbmlzL0NvcmUvSHR0cENvbnRleHQnXG5pbXBvcnQgUG9zdCBmcm9tICdBcHAvTW9kZWxzL1Bvc3QnXG5pbXBvcnQgU3RvcmVQb3N0VmFsaWRhdG9yIGZyb20gJ0FwcC9WYWxpZGF0b3JzL1Bvc3RzL1N0b3JlUG9zdFZhbGlkYXRvcidcbmltcG9ydCBVcGRhdGVQb3N0VmFsaWRhdG9yIGZyb20gJ0FwcC9WYWxpZGF0b3JzL1Bvc3RzL1VwZGF0ZVBvc3RWYWxpZGF0b3InXG5pbXBvcnQgQXBwbGljYXRpb24gZnJvbSAnQGlvYzpBZG9uaXMvQ29yZS9BcHBsaWNhdGlvbidcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUG9zdHNDb250cm9sbGVyIHtcbiAgcHVibGljIGFzeW5jIGluZGV4KHsgcmVzcG9uc2UgfTogSHR0cENvbnRleHRDb250cmFjdCkge1xuXG4gICAgY29uc3QgcG9zdHMgPSBhd2FpdCBQb3N0XG4gICAgICAucXVlcnkoKVxuICAgICAgLnByZWxvYWQoJ3VzZXInKVxuICAgICAgLm9yZGVyQnkoJ2NyZWF0ZWRfYXQnLCAnZGVzYycpXG5cbiAgICByZXR1cm4gcmVzcG9uc2Uub2socG9zdHMpXG4gIH1cbiAgcHVibGljIGFzeW5jIGxpa2VzKHsgcmVxdWVzdCwgcmVzcG9uc2UgfTogSHR0cENvbnRleHRDb250cmFjdCkge1xuICAgIGNvbnN0IHBheWxvYWQgPSByZXF1ZXN0LmJvZHkoKVxuICAgIGNvbnN0IHBvc3QgPSBhd2FpdCBQb3N0LmZpbmRPckZhaWwocGF5bG9hZC5wb3N0X2lkKVxuICAgIGNvbnN0IGxpa2VkX2J5ID0gcG9zdC4kYXR0cmlidXRlcy5saWtlZF9ieVxuICAgIGxldCB1bnBhY2tBcnIgPSBKU09OLnBhcnNlKGxpa2VkX2J5KVxuXG4gICAgdW5wYWNrQXJyID09IG51bGwgPz8gW11cblxuXG4gICAgaWYgKHVucGFja0FyciAhPSBudWxsICYmIHVucGFja0Fyci5pbmNsdWRlcyhwYXJzZUludChwYXlsb2FkLnVzZXJfaWQpKSkge1xuICAgICAgbGV0IGluZGV4ID0gdW5wYWNrQXJyLmluZGV4T2YocGFyc2VJbnQocGF5bG9hZC51c2VyX2lkKSlcbiAgICAgIHVucGFja0Fyci5zcGxpY2UoaW5kZXgpXG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgdW5wYWNrQXJyLnB1c2gocGFyc2VJbnQocGF5bG9hZC51c2VyX2lkKSlcbiAgICB9XG4gICAgbGV0IG1lcmdlYWJsZSA9IHt9XG4gICAgbGV0IGpzb24gPSBKU09OLnN0cmluZ2lmeSh1bnBhY2tBcnIpXG4gICAgT2JqZWN0LmFzc2lnbihtZXJnZWFibGUsIHsgbGlrZWRfYnk6IGpzb24gfSlcbiAgICBwb3N0Lm1lcmdlKG1lcmdlYWJsZSkuc2F2ZSgpXG4gICAgcmV0dXJuIHJlc3BvbnNlLm9rKHBvc3QpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc3RvcmUoeyByZXF1ZXN0LCByZXNwb25zZSB9OiBIdHRwQ29udGV4dENvbnRyYWN0KSB7XG4gICAgbGV0IHVybCA9IFwiXCJcbiAgICBjb25zdCBmaWxlID0gcmVxdWVzdC5maWxlKCdmaWxlJywge1xuICAgICAgc2l6ZTogJzJtYicsXG4gICAgICBleHRuYW1lczogWydqcGcnLCAnanBlZycsICdwbmcnXSxcbiAgICB9KVxuICAgIGlmIChmaWxlICE9IG51bGwgJiYgIWZpbGUuaXNWYWxpZCkge1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLnNlbmQoeyBtZXNzYWdlOiBcIkxlIGZpY2hpZXIgbidlc3QgcGFzIGF1IGJvbiBmb3JtYXRcIiB9KVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoZmlsZSAhPSBudWxsICYmIGZpbGUuaXNWYWxpZCkge1xuICAgICAgICBhd2FpdCBmaWxlLm1vdmUoQXBwbGljYXRpb24udG1wUGF0aCgndXBsb2FkcycpKVxuICAgICAgICBjb25zb2xlLmxvZyhmaWxlKVxuICAgICAgICB1cmwgPSBgaHR0cDovL2xvY2FsaG9zdDozMzMzL3VwbG9hZHMvJHtmaWxlLmZpbGVOYW1lfWBcbiAgICAgICAgY29uc29sZS5sb2coJ2lmJylcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICBjb25zb2xlLmxvZygnZWxzZScpXG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IHBheWxvYWQgPSBhd2FpdCByZXF1ZXN0LnZhbGlkYXRlKFN0b3JlUG9zdFZhbGlkYXRvcilcbiAgICBjb25zb2xlLmxvZyh1cmwpXG4gICAgcGF5bG9hZC5pbWdfdXJsID0gdXJsXG4gICAgY29uc3QgcG9zdCA9IGF3YWl0IFBvc3QuY3JlYXRlKHBheWxvYWQpXG4gICAgcmV0dXJuIHJlc3BvbnNlLmNyZWF0ZWQocG9zdClcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzaG93KHsgcmVzcG9uc2UsIHBhcmFtcyB9OiBIdHRwQ29udGV4dENvbnRyYWN0KSB7XG4gICAgY29uc3QgcG9zdCA9IGF3YWl0IFBvc3QuZmluZE9yRmFpbChwYXJhbXMpXG4gICAgcmV0dXJuIHJlc3BvbnNlLm9rKHBvc3QpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdXBkYXRlKHsgcmVxdWVzdCwgcmVzcG9uc2UsIHBhcmFtcyB9OiBIdHRwQ29udGV4dENvbnRyYWN0KSB7XG5cbiAgICBjb25zdCBwb3N0ID0gYXdhaXQgUG9zdC5maW5kT3JGYWlsKHBhcmFtcy5pZClcbiAgICBjb25zdCBwYXlsb2FkID0gYXdhaXQgcmVxdWVzdC52YWxpZGF0ZShVcGRhdGVQb3N0VmFsaWRhdG9yKVxuICAgIGxldCB1cmwgPSBcIlwiXG4gICAgY29uc3QgZmlsZSA9IHJlcXVlc3QuZmlsZSgnZmlsZScsIHtcbiAgICAgIHNpemU6ICcybWInLFxuICAgICAgZXh0bmFtZXM6IFsnanBnJywgJ2pwZWcnLCAncG5nJ10sXG4gICAgfSlcbiAgICBpZiAoZmlsZSAhPSBudWxsICYmICFmaWxlLmlzVmFsaWQpIHtcbiAgICAgIHJldHVybiByZXNwb25zZS5zZW5kKHsgbWVzc2FnZTogXCJMZSBmaWNoaWVyIG4nZXN0IHBhcyBhdSBib24gZm9ybWF0XCIgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGZpbGUgIT0gbnVsbCAmJiBmaWxlLmlzVmFsaWQpIHtcbiAgICAgICAgYXdhaXQgZmlsZS5tb3ZlKEFwcGxpY2F0aW9uLnRtcFBhdGgoJ3VwbG9hZHMnKSlcbiAgICAgICAgdXJsID0gYGh0dHA6Ly9sb2NhbGhvc3Q6MzMzMy91cGxvYWRzLyR7ZmlsZS5maWxlTmFtZX1gXG4gICAgICAgIHBheWxvYWQuaW1nX3VybCA9IHVybFxuICAgICAgfVxuICAgIH1cbiAgICBwb3N0Lm1lcmdlKHBheWxvYWQpLnNhdmUoKVxuICAgIHJldHVybiByZXNwb25zZS5vayhwb3N0KVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGRlc3Ryb3koeyByZXNwb25zZSwgcGFyYW1zIH06IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcblxuICAgIGNvbnN0IHBvc3QgPSBhd2FpdCBQb3N0LmZpbmRPckZhaWwocGFyYW1zLmlkKVxuICAgIHBvc3QuZGVsZXRlKClcbiAgICByZXR1cm4gcmVzcG9uc2Uub2socG9zdClcbiAgfVxufVxuIl19